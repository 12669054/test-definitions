metadata:
    format: Lava-Test Test Definition 1.0
    name: pi-stress-test
    description: "Stress test for POSIX Priority Inheritance mutexes"
    maintainer:
        - chase.qi@linaro.org
    os:
        - ubuntu
    scope:
        - functional
        - preempt-rt
    devices:
        - panda
        - panda-es
        - arndale
        - vexpress-a9
        - vexpress-tc2
        - beaglebone-black 
        - d01
        - rtsm_fvp_base-aemv8a
    environment:
        - lava-test-shell

install:
    deps:
        - rt-tests
params:
    # Length of the test run in seconds
    DURATION: 300
    # The number of inversion groups to run. By default pi_stress will detect the number of 
    # processors and determine the number of inversion groups automatically.
    GROUPS: 'default'
    # Set MLOCKALL to ture to lock current and future memory
    MLOCKALL: 'true'
    # Set RR to true if you need use SCHED_RR for test threads. The 
    # default is to run the inversion threads as SCHED_FIFO
    RR: 'false'

run:
    steps:
        - OPTIONS="--duration $DURATION"
        - if [ "$GROUPS" != "defalut" ]; then OPTIONS="$OPTIONS --groups $GROUPS"; fi
        - if [ "$MLOCKALL" == "true" ]; then OPTIONS="$OPTIONS --mlockall"; fi
        - if [ "$RR" != "false" ]; then OPTIONS="$OPTIONS --rr"; fi 
        - echo $OPTIONS
        - "lava-test-case pi-stress-test --shell pi_stress $OPTIONS"
